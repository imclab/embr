<!DOCTYPE HTML>
<head>
  <title>embr : framebuffer example</title>
  <script src="../build/embr.js"></script>
  <script src="../lib/gl-matrix.js"></script>
  <style>
  html, body {
    width: 100%; height: 100%;
    padding: 0; margin: 0;
    overflow: hidden;
  }
  #glcanvas {
    width: 100%; height: 100%;
  }
  </style>
</head>
<body onload="init()">
<script>

function init() {
  var canvas = document.getElementById("glcanvas")
    , gl = canvas.getContext("experimental-webgl");

  embr.setContext(gl);

  var textureProg = embr.Program.buildProgram({
    color: true,
    texture: true,
    colorOperator: '+'
  }).link();

  var plane = embr.Vbo.createPlane(-1, -1, 1, 1);
  var cube = embr.Vbo.createBox(-1, -1, -1, 1, 1, 1);

  // Create Framebuffers
  var fboSize = 256;
  var fbos = [];
  for(var i = 0; i < 2; ++i) {
    fbos.push(new embr.Fbo()
      .attach(new embr.Texture({
        width:  fboSize,
        height: fboSize,
        filter: gl.LINEAR,
        data:   null
      }))
      .attach(new embr.Rbo({
        width:  fboSize,
        height: fboSize
      }))
      .check()
    );
  }

  var transform = mat4.create();
  var projection = mat4.create();
  var modelview = mat4.create();

  var start = Date.now();

  function updateSize() {
    canvas.width = canvas.clientWidth;
    canvas.height = canvas.clientHeight;
  }

  function swapFbos() {
    var tmp = fbos[0];
    fbos[0] = fbos[1];
    fbos[1] = tmp;
  }

  function clearViewport (r, g, b, width, height) {
    gl.viewport(0, 0, width, height);
    gl.clearColor(r, g, b, 1);
    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
  }

  function draw () {
    var time = (Date.now() - start) / 1000;

    // First pass. Draw to framebuffer.
    mat4.ortho(-1, 1, -1, 1, -2, 2, projection);
    mat4.identity(modelview);
    mat4.scale(modelview, vec3.create([ 0.6, 0.6, 0.6 ]));
    mat4.rotateX(modelview, time + Math.sin(time) * 0.5);
    mat4.rotateZ(modelview, time + Math.cos(time) * 0.5);
    mat4.multiply(projection, modelview, transform);

    fbos[0].bind();

      clearViewport(0, 0, 0, fboSize, fboSize);

      gl.enable(gl.DEPTH_TEST);

      var t = time * 5, pi2 = Math.PI * 2;

      fbos[1].textures[0].bind();
      textureProg.use({
        uTransform: transform,
        uColor: [
          (Math.sin(t + pi2 * 0.33) + 1) * 0.05,
          (Math.sin(t + pi2 * 0.66) + 1) * 0.05,
          (Math.sin(t + pi2 * 1.00) + 1) * 0.05,
          1
        ]
      });
      cube.setProgram(textureProg).draw();
      fbos[1].textures[0].unbind();

    fbos[0].unbind();

    // Second pass. Draw to screen.
    var aspect = canvas.width / canvas.height;
    mat4.ortho(-aspect, aspect, -1, 1, -1, 1, projection);
    mat4.identity(modelview);
    mat4.rotateZ(modelview, time / -2);
    mat4.multiply(projection, modelview, transform);

    clearViewport(0, 0, 0, canvas.width, canvas.height);

    fbos[0].textures[0].bind();
    textureProg.use({
      uTransform: transform,
      uColor:     [ 0, 0, 0.25, 1 ]
    });
    plane.setProgram(textureProg).draw();
    fbos[0].textures[0].unbind();

    swapFbos();
  }

  window.addEventListener("resize", updateSize);
  updateSize();

  // Start Loop
  setInterval(draw, 1000 / 60);
}

</script>
<canvas id="glcanvas">
Your browser doesn't appear to support the HTML5 <code>&lt;canvas&gt;</code> element.
</canvas>
</body>
</html>
